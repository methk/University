"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var Rx_1 = require("rxjs/Rx");
var rpc_websockets_1 = require("rpc-websockets");
var RadixAtomModel_1 = require("../RadixAtomModel");
var RadixLogger_1 = require("../common/RadixLogger");
var events_1 = tslib_1.__importDefault(require("events"));
var RadixNodeConnection = /** @class */ (function (_super) {
    tslib_1.__extends(RadixNodeConnection, _super);
    function RadixNodeConnection(node, nodeRPCAddress) {
        var _this = _super.call(this) || this;
        _this.node = node;
        _this.nodeRPCAddress = nodeRPCAddress;
        _this._subscriptions = {};
        _this._atomUpdateSubjects = {};
        _this.lastSubscriberId = 1;
        _this.ping = function () {
            if (_this.isReady()) {
                _this._socket
                    .call('Network.getSelf', { id: 0 }).then(function (response) {
                    RadixLogger_1.logger.debug("Ping", response);
                });
            }
        };
        _this.close = function () {
            _this._socket.close();
        };
        _this._onClosed = function () {
            RadixLogger_1.logger.info('Socket closed');
            if (_this.pingInterval) {
                clearInterval(_this.pingInterval);
            }
            // Close subject
            for (var subscriberId in _this._subscriptions) {
                var subscription = _this._subscriptions[subscriberId];
                if (!subscription.closed) {
                    subscription.error('Socket closed');
                }
            }
            for (var subscriberId in _this._atomUpdateSubjects) {
                var subject = _this._atomUpdateSubjects[subscriberId];
                if (!subject.closed) {
                    subject.error('Socket closed');
                }
            }
            _this.emit('closed');
        };
        _this._onAtomSubmissionStateUpdate = function (notification) {
            RadixLogger_1.logger.info('Atom Submission state update', notification);
            // Handle atom state update
            var subscriberId = notification.subscriberId;
            var value = notification.value;
            var message = notification.message;
            var subject = _this._atomUpdateSubjects[subscriberId];
            switch (value) {
                case 'SUBMITTING':
                case 'SUBMITTED':
                    subject.next(value);
                    break;
                case 'STORED':
                    subject.next(value);
                    subject.complete();
                    break;
                case 'COLLISION':
                case 'ILLEGAL_STATE':
                case 'UNSUITABLE_PEER':
                case 'VALIDATION_ERROR':
                    subject.error(value + ': ' + message);
                    break;
            }
        };
        _this._onAtomReceivedNotification = function (notification) {
            var e_1, _a;
            RadixLogger_1.logger.info('Atom received', notification);
            // Store atom for testing
            // let jsonPath = './atomNotification.json'
            // // let jsonPath = path.join(__dirname, '..', '..', '..', '..', 'atomNotification.json')
            // logger.info(jsonPath)
            // fs.writeFile(jsonPath, JSON.stringify(notification), (error) => {
            //    // Throws an error, you could also catch it here
            //    if (error) { throw error }
            //    // Success case, the file was saved
            //    logger.info('Atom saved!')
            // })
            var deserializedAtoms = RadixAtomModel_1.RadixSerializer.fromJson(notification.atoms);
            RadixLogger_1.logger.info(deserializedAtoms);
            // Check HIDs for testing
            for (var i = 0; i < deserializedAtoms.length; i++) {
                var deserializedAtom = deserializedAtoms[i];
                var serializedAtom = notification.atoms[i];
                if (serializedAtom.hid &&
                    deserializedAtom.hid.equals(RadixAtomModel_1.RadixEUID.fromJson(serializedAtom.hid))) {
                    RadixLogger_1.logger.info('HID match');
                }
                else if (serializedAtom.hid) {
                    RadixLogger_1.logger.error('HID mismatch');
                }
            }
            // Forward atoms to correct wallets
            var subscription = _this._subscriptions[notification.subscriberId];
            try {
                for (var deserializedAtoms_1 = tslib_1.__values(deserializedAtoms), deserializedAtoms_1_1 = deserializedAtoms_1.next(); !deserializedAtoms_1_1.done; deserializedAtoms_1_1 = deserializedAtoms_1.next()) {
                    var atom = deserializedAtoms_1_1.value;
                    subscription.next({
                        action: 'STORE',
                        atom: atom,
                    });
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (deserializedAtoms_1_1 && !deserializedAtoms_1_1.done && (_a = deserializedAtoms_1.return)) _a.call(deserializedAtoms_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
        };
        _this.node = node;
        return _this;
    }
    RadixNodeConnection.prototype.getSubscriberId = function () {
        this.lastSubscriberId++;
        return this.lastSubscriberId;
    };
    /**
     * Check whether the node connection is ready for requests
     * @returns true if ready
     */
    RadixNodeConnection.prototype.isReady = function () {
        return this._socket && this._socket.ready;
    };
    /**
     * Opens connection
     * @returns a promise that resolves once the connection is ready, or rejects on error or timeout
     */
    RadixNodeConnection.prototype.openConnection = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, new Promise(function (resolve, reject) {
                        _this.address = _this.nodeRPCAddress(_this.node.host.ip);
                        // For testing atom queueing during connection issues
                        // if (Math.random() > 0.1) {
                        //    this.address += 'garbage'
                        // }
                        RadixLogger_1.logger.info("Connecting to " + _this.address);
                        _this._socket = new rpc_websockets_1.Client(_this.address, {
                            reconnect: false
                        });
                        _this._socket.on('close', _this._onClosed);
                        _this._socket.on('error', function (error) {
                            RadixLogger_1.logger.error(error);
                            reject(error);
                        });
                        setTimeout(function () {
                            if (!_this._socket.ready) {
                                RadixLogger_1.logger.debug('Socket timeout');
                                _this._socket.close();
                                _this.emit('closed');
                                reject('Timeout');
                            }
                        }, 5000);
                        _this._socket.on('open', function () {
                            // this.pingInterval = setInterval(this.ping, 10000)
                            _this.emit('open');
                            _this._socket.on('Atoms.subscribeUpdate', _this._onAtomReceivedNotification);
                            _this._socket.on('AtomSubmissionState.onNext', _this._onAtomSubmissionStateUpdate);
                            resolve();
                        });
                    })];
            });
        });
    };
    /**
     * Subscribe for all existing and future atoms for a given address
     * @param address base58 formatted address
     * @returns a stream of atoms
     */
    RadixNodeConnection.prototype.subscribe = function (address) {
        var subscriberId = this.getSubscriberId();
        var subscription = new Rx_1.Subject();
        this._subscriptions[subscriberId] = subscription;
        this._socket
            .call('Atoms.subscribe', {
            subscriberId: subscriberId,
            query: {
                destinationAddress: address,
            },
        })
            .then(function (response) {
            RadixLogger_1.logger.info("Subscribed for address " + address, response);
        })
            .catch(function (error) {
            RadixLogger_1.logger.error(error);
            subscription.error(error);
        });
        return subscription;
    };
    /**
     * Submit an atom to the ledger
     * @param atom
     * @returns A stream of the status of the atom submission
     */
    RadixNodeConnection.prototype.submitAtom = function (atom) {
        // Store atom for testing
        // let jsonPath = path.join('./submitAtom.json')
        // logger.info(jsonPath)
        // fs.writeFile(jsonPath, JSON.stringify(atom.toJson()), (error) => {
        //    // Throws an error, you could also catch it here
        //    if (error) { throw error }
        var _this = this;
        //    // Success case, the file was saved
        //    logger.info('Atom saved!')
        // })
        var subscriberId = this.getSubscriberId();
        var atomStateSubject = new Rx_1.BehaviorSubject('CREATED');
        this._atomUpdateSubjects[subscriberId] = atomStateSubject;
        var timeout = setTimeout(function () {
            _this._socket.close();
            atomStateSubject.error('Socket timeout');
        }, 5000);
        this._socket
            .call('Universe.submitAtomAndSubscribe', {
            subscriberId: subscriberId,
            atom: atom.toJson()
        })
            .then(function () {
            clearTimeout(timeout);
            atomStateSubject.next('SUBMITTED');
        })
            .catch(function (error) {
            clearTimeout(timeout);
            atomStateSubject.error(error);
        });
        return atomStateSubject;
    };
    /**
     * NOT IMPLEMENTED
     * Query the ledger for an atom by its id
     * @param id
     * @returns The atom
     */
    RadixNodeConnection.prototype.getAtomById = function (id) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                // TODO: everything
                return [2 /*return*/, this._socket
                        .call('Atoms.getAtomInfo', { id: id.toJson() })
                        .then(function (response) {
                        return RadixAtomModel_1.RadixSerializer.fromJson(response.result);
                    })];
            });
        });
    };
    return RadixNodeConnection;
}(events_1.default.EventEmitter));
exports.RadixNodeConnection = RadixNodeConnection;
exports.default = RadixNodeConnection;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmFkaXhOb2RlQ29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tb2R1bGVzL3VuaXZlcnNlL1JhZGl4Tm9kZUNvbm5lY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsOEJBQWtEO0FBQ2xELGlEQUF1QztBQUl2QyxvREFBMEY7QUFDMUYscURBQThDO0FBRTlDLDBEQUEyQjtBQW9CM0I7SUFBeUMsK0NBQW1CO0lBZXhELDZCQUFxQixJQUFlLEVBQVcsY0FBMEM7UUFBekYsWUFDSSxpQkFBTyxTQUVWO1FBSG9CLFVBQUksR0FBSixJQUFJLENBQVc7UUFBVyxvQkFBYyxHQUFkLGNBQWMsQ0FBNEI7UUFaakYsb0JBQWMsR0FFbEIsRUFBRSxDQUFBO1FBRUUseUJBQW1CLEdBRXZCLEVBQUUsQ0FBQTtRQUVFLHNCQUFnQixHQUFHLENBQUMsQ0FBQTtRQXNCcEIsVUFBSSxHQUFHO1lBQ1gsSUFBSSxLQUFJLENBQUMsT0FBTyxFQUFFLEVBQUU7Z0JBQ2hCLEtBQUksQ0FBQyxPQUFPO3FCQUNYLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLFFBQWE7b0JBQ25ELG9CQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQTtnQkFDbEMsQ0FBQyxDQUFDLENBQUE7YUFDTDtRQUNMLENBQUMsQ0FBQTtRQWdKTSxXQUFLLEdBQUc7WUFDWCxLQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFBO1FBQ3hCLENBQUMsQ0FBQTtRQUVPLGVBQVMsR0FBRztZQUNoQixvQkFBTSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQTtZQUU1QixJQUFJLEtBQUksQ0FBQyxZQUFZLEVBQUU7Z0JBQ25CLGFBQWEsQ0FBQyxLQUFJLENBQUMsWUFBWSxDQUFDLENBQUE7YUFDbkM7WUFFRCxnQkFBZ0I7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